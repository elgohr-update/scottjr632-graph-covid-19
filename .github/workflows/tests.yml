name: Jest Test
on: [push]
jobs:
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Set up Node
      uses: actions/setup-node@v1
      with:
        node-version: '10.x'
    - name: Install
      run: npm install
    - name: test
      run: npm run test
  docker:
    name: Build and test Docker
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Build
      run: docker build . --file Dockerfile --tag image
    - name: Start container
      run: docker run --rm -d -p 4000:4000 --name my-image image
    - name: Test image is running
      run: |
        code=$(curl -X POST --header "Content-Type: application/json" \
        --data '{"operationName":null,"variables":{},"query":"{\n  jhu {\n    data {\n      total\n    }\n  }\n}\n"}' \
        http://localhost:4000)
        if [[ $code -ne 200 ]]; then exit 1; else exit 0; fi
    - name: Stop container
      run: docker stop my-image